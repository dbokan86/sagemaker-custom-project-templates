image: python:latest

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip
    - venv/

before_script:
  - python -V 
  - pip install virtualenv
  - virtualenv venv
  - source venv/bin/activate
  - mkdir -p ~/.aws
  - echo "${MY_OIDC_TOKEN}" > /tmp/web_identity_token
  - echo -e "[default]\nrole_arn=${GITLAB_IAM_ROLE_ARN}\nweb_identity_token_file=/tmp/web_identity_token" > ~/.aws/config

stages:
  - training

train-model:
  stage: training
  id_tokens:
    MY_OIDC_TOKEN:
      aud: "https://$CI_SERVER_HOST"
  script: 
      - pip install --upgrade --force-reinstall . "awscli>1.20.30"
      - export PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python
      - export PYTHONUNBUFFERED=TRUE
      - export SAGEMAKER_PROJECT_NAME_ID="${SAGEMAKER_PROJECT_NAME}-${SAGEMAKER_PROJECT_ID}"
      - |
        run-pipeline --module-name pipelines.abalone.pipeline \
          --role-arn $SAGEMAKER_PIPELINE_ROLE_ARN \
          --tags "[{\"Key\":\"sagemaker:project-name\", \"Value\":\"${SAGEMAKER_PROJECT_NAME}\"}, {\"Key\":\"sagemaker:project-id\", \"Value\":\"${SAGEMAKER_PROJECT_ID}\"}]" \
          --kwargs "{\"region\":\"${AWS_REGION}\",\"sagemaker_project_arn\":\"${SAGEMAKER_PROJECT_ARN}\",\"role\":\"${SAGEMAKER_PIPELINE_ROLE_ARN}\",\"default_bucket\":\"${ARTIFACT_BUCKET}\",\"pipeline_name\":\"${SAGEMAKER_PROJECT_NAME_ID}\",\"model_package_group_name\":\"${SAGEMAKER_PROJECT_NAME_ID}\",\"base_job_prefix\":\"${SAGEMAKER_PROJECT_NAME_ID}\",\"queue_url\":\"${CALLBACK_QUEUE_URL}\"}"
      - echo "Create/Update of the SageMaker Pipeline and execution completed."
